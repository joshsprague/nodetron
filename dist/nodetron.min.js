!function(a){function b(){this._pieces=[],this._parts=[]}function c(a){this.index=0,this.dataBuffer=a,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function d(a){this.utf8=a,this.bufferBuilder=new b}function e(){this._events={}}function f(a,b){return this instanceof f?(this._dc=a,m.debug=b,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],this._setupDC(),void 0):new f(a)}function g(a,b,c){if(a&&a.constructor==Object&&(b=a,a=void 0),!(this instanceof g))return new g(a,b);e.call(this),b=m.extend({debug:!1,key:"peerjs",config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},b),this._options=b,m.debug=b.debug;var d=this;return m.isBrowserCompatible()?("/"===b.host&&(b.host=window.location.hostname),a&&!/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(a)?(m.setZeroTimeout(function(){d._abort("invalid-id",'ID "'+a+'" is invalid')}),void 0):b.key&&!/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(b.key)?(m.setZeroTimeout(function(){d._abort("invalid-key",'API KEY "'+b.key+'" is invalid')}),void 0):(this._secure=m.isSecure(),this.destroyed=!1,this.disconnected=!1,this.connections={},this.managers={},this._queued=[],a?(this.id=a,this._init(c)):(this.id=null,this._retrieveId()),void 0)):(m.setZeroTimeout(function(){d._abort("browser-incompatible","The current browser does not support WebRTC DataChannels")}),void 0)}function h(a,b,c){return this instanceof h?(e.call(this),c=m.extend({serialization:"binary"},c),this.open=!1,this.label=c.label,this.metadata=c.metadata,this.serialization=c.serialization,this.peer=a,this.reliable=c.reliable,this._dc=b,this._dc&&this._configureDataChannel(),void 0):new h(a,b,c)}function i(a,b,c,d){return this instanceof i?(e.call(this),d=m.extend({config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},d),this._options=d,this.open=!0,this.id=a,this.peer=b,this.pc=null,this.labels={},this._default=0,this.connections={},this._queued=[],this._socket=c,this.id&&this.initialize(),void 0):new i(a,b,c,d)}function j(a,b,c,d){if(!(this instanceof j))return new j(a,b,c,d);e.call(this),this._id=d;var f=m.randomToken();this.disconnected=!1;var g=m.isSecure(),h=g?"https://":"http://",i=g?"wss://":"ws://";this._httpUrl=h+a+":"+b+"/"+c+"/"+d+"/"+f,this._wsUrl=i+a+":"+b+"/peerjs?key="+c+"&id="+d+"&token="+f}var k={};k.useBlobBuilder=function(){try{return new Blob([]),!1}catch(a){return!0}}(),k.useArrayBufferView=!k.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(a){return!0}}(),a.binaryFeatures=k,a.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,b.prototype.append=function(a){"number"==typeof a?this._pieces.push(a):(this._flush(),this._parts.push(a))},b.prototype._flush=function(){if(this._pieces.length>0){var a=new Uint8Array(this._pieces);k.useArrayBufferView||(a=a.buffer),this._parts.push(a),this._pieces=[]}},b.prototype.getBuffer=function(){if(this._flush(),k.useBlobBuilder){for(var a=new BlobBuilder,b=0,c=this._parts.length;c>b;b++)a.append(this._parts[b]);return a.getBlob()}return new Blob(this._parts)},a.BinaryPack={unpack:function(a){var b=new c(a);return b.unpack()},pack:function(a,b){var c=new d(b),e=c.pack(a);return e}},c.prototype.unpack=function(){var a=this.unpack_uint8();if(128>a){var b=a;return b}if(32>(224^a)){var c=(224^a)-32;return c}var d;if((d=160^a)<=15)return this.unpack_raw(d);if((d=176^a)<=15)return this.unpack_string(d);if((d=144^a)<=15)return this.unpack_array(d);if((d=128^a)<=15)return this.unpack_map(d);switch(a){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return d=this.unpack_uint16(),this.unpack_string(d);case 217:return d=this.unpack_uint32(),this.unpack_string(d);case 218:return d=this.unpack_uint16(),this.unpack_raw(d);case 219:return d=this.unpack_uint32(),this.unpack_raw(d);case 220:return d=this.unpack_uint16(),this.unpack_array(d);case 221:return d=this.unpack_uint32(),this.unpack_array(d);case 222:return d=this.unpack_uint16(),this.unpack_map(d);case 223:return d=this.unpack_uint32(),this.unpack_map(d)}},c.prototype.unpack_uint8=function(){var a=255&this.dataView[this.index];return this.index++,a},c.prototype.unpack_uint16=function(){var a=this.read(2),b=256*(255&a[0])+(255&a[1]);return this.index+=2,b},c.prototype.unpack_uint32=function(){var a=this.read(4),b=256*(256*(256*a[0]+a[1])+a[2])+a[3];return this.index+=4,b},c.prototype.unpack_uint64=function(){var a=this.read(8),b=256*(256*(256*(256*(256*(256*(256*a[0]+a[1])+a[2])+a[3])+a[4])+a[5])+a[6])+a[7];return this.index+=8,b},c.prototype.unpack_int8=function(){var a=this.unpack_uint8();return 128>a?a:a-256},c.prototype.unpack_int16=function(){var a=this.unpack_uint16();return 32768>a?a:a-65536},c.prototype.unpack_int32=function(){var a=this.unpack_uint32();return a<Math.pow(2,31)?a:a-Math.pow(2,32)},c.prototype.unpack_int64=function(){var a=this.unpack_uint64();return a<Math.pow(2,63)?a:a-Math.pow(2,64)},c.prototype.unpack_raw=function(a){if(this.length<this.index+a)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+a+" "+this.length);var b=this.dataBuffer.slice(this.index,this.index+a);return this.index+=a,b},c.prototype.unpack_string=function(a){for(var b,c,d=this.read(a),e=0,f="";a>e;)b=d[e],128>b?(f+=String.fromCharCode(b),e++):32>(192^b)?(c=(192^b)<<6|63&d[e+1],f+=String.fromCharCode(c),e+=2):(c=(15&b)<<12|(63&d[e+1])<<6|63&d[e+2],f+=String.fromCharCode(c),e+=3);return this.index+=a,f},c.prototype.unpack_array=function(a){for(var b=new Array(a),c=0;a>c;c++)b[c]=this.unpack();return b},c.prototype.unpack_map=function(a){for(var b={},c=0;a>c;c++){var d=this.unpack(),e=this.unpack();b[d]=e}return b},c.prototype.unpack_float=function(){var a=this.unpack_uint32(),b=a>>31,c=(255&a>>23)-127,d=8388608|8388607&a;return(0==b?1:-1)*d*Math.pow(2,c-23)},c.prototype.unpack_double=function(){var a=this.unpack_uint32(),b=this.unpack_uint32(),c=a>>31,d=(2047&a>>20)-1023,e=1048576|1048575&a,f=e*Math.pow(2,d-20)+b*Math.pow(2,d-52);return(0==c?1:-1)*f},c.prototype.read=function(a){var b=this.index;if(b+a<=this.length)return this.dataView.subarray(b,b+a);throw new Error("BinaryPackFailure: read index out of range")},d.prototype.pack=function(a){var b=typeof a;if("string"==b)this.pack_string(a);else if("number"==b)Math.floor(a)===a?this.pack_integer(a):this.pack_double(a);else if("boolean"==b)a===!0?this.bufferBuilder.append(195):a===!1&&this.bufferBuilder.append(194);else if("undefined"==b)this.bufferBuilder.append(192);else{if("object"!=b)throw new Error('Type "'+b+'" not yet supported');if(null===a)this.bufferBuilder.append(192);else{var c=a.constructor;if(c==Array)this.pack_array(a);else if(c==Blob||c==File)this.pack_bin(a);else if(c==ArrayBuffer)k.useArrayBufferView?this.pack_bin(new Uint8Array(a)):this.pack_bin(a);else if("BYTES_PER_ELEMENT"in a)k.useArrayBufferView?this.pack_bin(a):this.pack_bin(a.buffer);else if(c==Object)this.pack_object(a);else if(c==Date)this.pack_string(a.toString());else{if("function"!=typeof a.toBinaryPack)throw new Error('Type "'+c.toString()+'" not yet supported');this.bufferBuilder.append(a.toBinaryPack())}}}return this.bufferBuilder.getBuffer()},d.prototype.pack_bin=function(a){var b=a.length||a.byteLength||a.size;if(15>=b)this.pack_uint8(160+b);else if(65535>=b)this.bufferBuilder.append(218),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(b)}this.bufferBuilder.append(a)},d.prototype.pack_string=function(a){var b;if(this.utf8){var c=new Blob([a]);b=c.size}else b=a.length;if(15>=b)this.pack_uint8(176+b);else if(65535>=b)this.bufferBuilder.append(216),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(b)}this.bufferBuilder.append(a)},d.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(b)}for(var c=0;b>c;c++)this.pack(a[c])},d.prototype.pack_integer=function(a){if(a>=-32&&127>=a)this.bufferBuilder.append(255&a);else if(a>=0&&255>=a)this.bufferBuilder.append(204),this.pack_uint8(a);else if(a>=-128&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(a>=0&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(a>=-32768&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(a>=0&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(a>=-2147483648&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(a>=-0x8000000000000000&&0x8000000000000000>=a)this.bufferBuilder.append(211),this.pack_int64(a);else{if(!(a>=0&&0x10000000000000000>=a))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(a)}},d.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var c=Math.floor(Math.log(a)/Math.LN2),d=a/Math.pow(2,c)-1,e=Math.floor(d*Math.pow(2,52)),f=Math.pow(2,32),g=b<<31|c+1023<<20|1048575&e/f,h=e%f;this.bufferBuilder.append(203),this.pack_int32(g),this.pack_int32(h)},d.prototype.pack_object=function(a){var b=Object.keys(a),c=b.length;if(15>=c)this.pack_uint8(128+c);else if(65535>=c)this.bufferBuilder.append(222),this.pack_uint16(c);else{if(!(4294967295>=c))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(c)}for(var d in a)a.hasOwnProperty(d)&&(this.pack(d),this.pack(a[d]))},d.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)},d.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8),this.bufferBuilder.append(255&a)},d.prototype.pack_uint32=function(a){var b=4294967295&a;this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b)},d.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)},d.prototype.pack_int8=function(a){this.bufferBuilder.append(255&a)},d.prototype.pack_int16=function(a){this.bufferBuilder.append((65280&a)>>8),this.bufferBuilder.append(255&a)},d.prototype.pack_int32=function(a){this.bufferBuilder.append(255&a>>>24),this.bufferBuilder.append((16711680&a)>>>16),this.bufferBuilder.append((65280&a)>>>8),this.bufferBuilder.append(255&a)},d.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32)),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)};var l=Array.isArray;e.prototype.addListener=function(a,b){if("function"!=typeof b)throw new Error("addListener only takes instances of Function");return this.emit("newListener",a,"function"==typeof b.listener?b.listener:b),this._events[a]?l(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(a,b){function c(){d.removeListener(a,c),b.apply(this,arguments)}if("function"!=typeof b)throw new Error(".once only takes instances of Function");var d=this;return c.listener=b,d.on(a,c),this},e.prototype.removeListener=function(a,b){if("function"!=typeof b)throw new Error("removeListener only takes instances of Function");if(!this._events[a])return this;var c=this._events[a];if(l(c)){for(var d=-1,e=0,f=c.length;f>e;e++)if(c[e]===b||c[e].listener&&c[e].listener===b){d=e;break}if(0>d)return this;c.splice(d,1),0==c.length&&delete this._events[a]}else(c===b||c.listener&&c.listener===b)&&delete this._events[a];return this},e.prototype.off=e.prototype.removeListener,e.prototype.removeAllListeners=function(a){return 0===arguments.length?(this._events={},this):(a&&this._events&&this._events[a]&&(this._events[a]=null),this)},e.prototype.listeners=function(a){return this._events[a]||(this._events[a]=[]),l(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},e.prototype.emit=function(a){var a=arguments[0],b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];b.apply(this,d)}return!0}if(l(b)){for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];for(var f=b.slice(),e=0,c=f.length;c>e;e++)f[e].apply(this,d);return!0}return!1};var m={chromeCompatible:!0,firefoxCompatible:!0,chromeVersion:26,firefoxVersion:22,debug:!1,browserisms:"",inherits:function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(m.debug){var a=!1,b=Array.prototype.slice.call(arguments);b.unshift("PeerJS: ");for(var c=0,d=b.length;d>c;c++)b[c]instanceof Error&&(b[c]="("+b[c].name+") "+b[c].message,a=!0);a?console.error.apply(console,b):console.log.apply(console,b)}},setZeroTimeout:function(a){function b(b){d.push(b),a.postMessage(e,"*")}function c(b){b.source==a&&b.data==e&&(b.stopPropagation&&b.stopPropagation(),d.length&&d.shift()())}var d=[],e="zero-timeout-message";return a.addEventListener?a.addEventListener("message",c,!0):a.attachEvent&&a.attachEvent("onmessage",c),b}(this),blobToArrayBuffer:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsArrayBuffer(a)},blobToBinaryString:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsBinaryString(a)},binaryStringToArrayBuffer:function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=255&a.charCodeAt(c);return b.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isBrowserCompatible:function(){var a,b;if(this.chromeCompatible&&(a=navigator.userAgent.split("Chrome/"))&&a.length>1){var c=a[1].split(".")[0];return parseInt(c)>=this.chromeVersion}if(this.firefoxCompatible&&(b=navigator.userAgent.split("Firefox/"))&&b.length>1){var c=b[1].split(".")[0];return parseInt(c)>=this.firefoxVersion}return!1},isSecure:function(){return"https:"===location.protocol}};f.prototype.send=function(a){var b=m.pack(a);return b.size<this._mtu?(this._handleSend(["no",b]),void 0):(this._outgoing[this._count]={ack:0,chunks:this._chunk(b)},m.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),this._count+=1,void 0)},f.prototype._setupInterval=function(){var a=this;this._timeout=setInterval(function(){var b=a._queue.shift();if(b._multiple)for(var c=0,d=b.length;d>c;c+=1)a._intervalSend(b[c]);else a._intervalSend(b)},this._interval)},f.prototype._intervalSend=function(a){var b=this;a=m.pack(a),m.blobToBinaryString(a,function(a){b._dc.send(a)}),0===b._queue.length&&(clearTimeout(b._timeout),b._timeout=null)},f.prototype._processAcks=function(){for(var a in this._outgoing)this._outgoing.hasOwnProperty(a)&&this._sendWindowedChunks(a)},f.prototype._handleSend=function(a){for(var b=!0,c=0,d=this._queue.length;d>c;c+=1){var e=this._queue[c];e===a?b=!1:e._multiple&&-1!==e.indexOf(a)&&(b=!1)}b&&(this._queue.push(a),this._timeout||this._setupInterval())},f.prototype._setupDC=function(){var a=this;this._dc.onmessage=function(b){var c=b.data,d=c.constructor;if(d===String){var e=m.binaryStringToArrayBuffer(c);c=m.unpack(e),a._handleMessage(c)}}},f.prototype._handleMessage=function(a){var b,c=a[1],d=this._incoming[c],e=this._outgoing[c];switch(a[0]){case"no":var f=c;f&&this.onmessage(m.unpack(f));break;case"end":if(b=d,this._received[c]=a[2],!b)break;this._ack(c);break;case"ack":if(b=e){var g=a[2];b.ack=Math.max(g,b.ack),b.ack>=b.chunks.length?(m.log("Time: ",new Date-b.timer),delete this._outgoing[c]):this._processAcks()}break;case"chunk":if(b=d,!b){var h=this._received[c];if(h===!0)break;b={ack:["ack",c,0],chunks:[]},this._incoming[c]=b}var i=a[2],j=a[3];b.chunks[i]=new Uint8Array(j),i===b.ack[2]&&this._calculateNextAck(c),this._ack(c);break;default:this._handleSend(a)}},f.prototype._chunk=function(a){for(var b=[],c=a.size,d=0;c>d;){var e=Math.min(c,d+this._mtu),f=a.slice(d,e),g={payload:f};b.push(g),d=e}return m.log("Created",b.length,"chunks."),b},f.prototype._ack=function(a){var b=this._incoming[a].ack;this._received[a]===b[2]&&(this._complete(a),this._received[a]=!0),this._handleSend(b)},f.prototype._calculateNextAck=function(a){for(var b=this._incoming[a],c=b.chunks,d=0,e=c.length;e>d;d+=1)if(void 0===c[d])return b.ack[2]=d,void 0;b.ack[2]=c.length},f.prototype._sendWindowedChunks=function(a){m.log("sendWindowedChunks for: ",a);for(var b=this._outgoing[a],c=b.chunks,d=[],e=Math.min(b.ack+this._window,c.length),f=b.ack;e>f;f+=1)c[f].sent&&f!==b.ack||(c[f].sent=!0,d.push(["chunk",a,f,c[f].payload]));b.ack+this._window>=c.length&&d.push(["end",a,c.length]),d._multiple=!0,this._handleSend(d)},f.prototype._complete=function(a){m.log("Completed called for",a);var b=this,c=this._incoming[a].chunks,d=new Blob(c);m.blobToArrayBuffer(d,function(a){b.onmessage(m.unpack(a))}),delete this._incoming[a]},f.higherBandwidthSDP=function(a){var b=a.split("b=AS:30"),c="b=AS:102400";return b[0]+c+b[1]},f.prototype.onmessage=function(){},a.Reliable=f,m.browserisms=window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Webkit":"Unknown",a.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,a.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,m.inherits(g,e),g.prototype._retrieveId=function(){var a=this;try{var b=new XMLHttpRequest,c=this._secure?"https://":"http://",d=c+this._options.host+":"+this._options.port+"/"+this._options.key+"/id",e="?ts="+(new Date).getTime()+Math.random();d+=e,b.open("get",d,!0),b.onreadystatechange=function(){if(4===b.readyState){if(200!==b.status)throw"Retrieve ID response not 200";a.id=b.responseText,a._init()}},b.send(null)}catch(f){this._abort("server-error","Could not get an ID from the server")}},g.prototype._init=function(a){var b=this;this._socket=a?a:new j(this._options.host,this._options.port,this._options.key,this.id),this._socket.on("message",function(a){b._handleServerJSONMessage(a)}),this._socket.on("error",function(a){m.log(a),b._abort("socket-error",a)});var c="disconnect";a||(c="close"),this._socket.on(c,function(){var a="Underlying socket has closed";m.log("error",a),b._abort("socket-closed",a)}),a||this._socket.start()},g.prototype._handleServerJSONMessage=function(a){this._socket._startXhrStream||(a=JSON.parse(a));var b=a.src,c=this.managers[b],d=a.payload;switch(a.type){case"OPEN":this._processQueue(),this.emit("open",this.id);break;case"ERROR":this._abort("server-error",d.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"OFFER":var e={sdp:d.sdp,labels:d.labels,config:this._options.config},c=this.managers[b];c||(c=new i(this.id,b,this._socket,e),this._attachManagerListeners(c),this.managers[b]=c,this.connections[b]=c.connections),c.update(e.labels),c.handleSDP(d.sdp,a.type);break;case"EXPIRE":c&&(c.close(),c.emit("error",new Error("Could not connect to peer "+c.peer)));break;case"ANSWER":c&&c.handleSDP(d.sdp,a.type);break;case"CANDIDATE":c&&c.handleCandidate(d);break;case"LEAVE":c&&c.handleLeave();break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this._key+'" is invalid');break;default:m.log("Unrecognized message type:",a.type)}},g.prototype._processQueue=function(){for(;this._queued.length>0;){var a=this._queued.pop();a.initialize(this.id,this._socket)}},g.prototype._attachManagerListeners=function(a){var b=this;a.on("connection",function(a){b.emit("connection",a)}),a.on("close",function(){b.managers[a.peer]&&(delete b.managers[a.peer],delete b.connections[a.peer])}),a.on("error",function(a){b.emit("error",a)})},g.prototype._abort=function(a,b){m.log("Aborting. Error:",b);var c=new Error(b);c.type=a,this.destroy(),this.emit("error",c)},g.prototype._cleanup=function(){var a=this;if(this.managers)for(var b=Object.keys(this.managers),c=0,d=b.length;d>c;c++)this.managers[b[c]].close();m.setZeroTimeout(function(){a.disconnect()}),this.emit("close")},g.prototype.connect=function(a,b){if(this.disconnected){var c=new Error("This Peer has been disconnected from the server and can no longer make connections.");return c.type="server-disconnected",this.emit("error",c),void 0}b=m.extend({config:this._options.config},b);var d=this.managers[a];if("Firefox"===m.browserisms&&d&&d.firefoxSingular){var c=new Error("Firefox currently does not support multiplexing after a DataChannel has already been established");return c.type="firefoxism",this.emit("error",c),void 0}d||(d=new i(this.id,a,this._socket,b),this._attachManagerListeners(d),this.managers[a]=d,this.connections[a]=d.connections);var e=d.connect(b);return this.id||this._queued.push(d),e},g.prototype.getId=function(){return this.id},g.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.destroyed=!0)},g.prototype.disconnect=function(){if(!this.disconnected){if(this._socket){var a=this._socket;a instanceof j?this._socket.close():a.disconnect()}this.id=null,this.disconnected=!0}},g.browser=m.browserisms,g.prototype.isConnected=function(){return!this.disconnected},g.prototype.isDestroyed=function(){return this.destroyed},a.Peer=g,m.inherits(h,e),h.prototype._configureDataChannel=function(){var a=this;"Webkit"!==m.browserisms&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){m.log("Data channel connection success"),a.open=!0,a.emit("open")},this.reliable&&"Firefox"!==m.browserisms&&(this._reliable=new f(this._dc,m.debug)),this._reliable?this._reliable.onmessage=function(b){a.emit("data",b)}:this._dc.onmessage=function(b){a._handleDataMessage(b)},this._dc.onclose=function(){m.log("DataChannel closed."),a.close()}},h.prototype._cleanup=function(){this._dc&&"closed"!==this._dc.readyState&&(this._dc.close(),this._dc=null),this.open=!1,this.emit("close")},h.prototype._handleDataMessage=function(a){var b=this,c=a.data,d=c.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(d===Blob)return m.blobToArrayBuffer(c,function(a){c=m.unpack(a),b.emit("data",c)}),void 0;if(d===ArrayBuffer)c=m.unpack(c);else if(d===String){var e=m.binaryStringToArrayBuffer(c);c=m.unpack(e)}}else"json"===this.serialization&&(c=JSON.parse(c));this.emit("data",c)},h.prototype.addDC=function(a){this._dc=a,this._configureDataChannel()},h.prototype.close=function(){this.open&&this._cleanup()},h.prototype.send=function(a){if(this.open||this.emit("error",new Error("Connection no longer open.")),this._reliable)return this._reliable.send(a),void 0;var b=this;if("none"===this.serialization)this._dc.send(a);else if("json"===this.serialization)this._dc.send(JSON.stringify(a));else{var c="binary-utf8"===this.serialization,d=m.pack(a,c);"Webkit"===m.browserisms?m.blobToBinaryString(d,function(a){b._dc.send(a)}):this._dc.send(d)}},h.prototype.isOpen=function(){return this.open},h.prototype.getMetadata=function(){return this.metadata},h.prototype.getLabel=function(){return this.label},h.prototype.getPeer=function(){return this.peer};var n=function(a,b){a._startXhrStream?a.send(b):a.emit("nodetron",b)};m.inherits(i,e),i.prototype.initialize=function(a,b){a&&(this.id=a),b&&(this._socket=b),this._startPeerConnection(),this._processQueue(),this._setupIce(),this._setupNegotiationHandler(),this._setupDataChannel(),this.initialize=function(){}},i.prototype._startPeerConnection=function(){m.log("Creating RTCPeerConnection"),this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:!0}]})},i.prototype._processQueue=function(){var a=this._queued.pop();if(a){var b="Firefox"===m.browserisms?a.reliable:!1;a.addDC(this.pc.createDataChannel(a.label,{reliable:b}))}},i.prototype._setupIce=function(){m.log("Listening for ICE candidates.");var a=this;this.pc.onicecandidate=function(b){b.candidate&&(m.log("Received ICE candidates."),n(a._socket,{type:"CANDIDATE",payload:{candidate:b.candidate},dst:a.peer}))},this.pc.oniceconnectionstatechange=function(){a.pc&&"disconnected"===a.pc.iceConnectionState&&(m.log("iceConnectionState is disconnected, closing connections to "+this.peer),a.close())},this.pc.onicechange=this.pc.oniceconnectionstatechange},i.prototype._setupNegotiationHandler=function(){var a=this;m.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){m.log("`negotiationneeded` triggered"),a._makeOffer()}},i.prototype._setupDataChannel=function(){var a=this;m.log("Listening for data channel"),this.pc.ondatachannel=function(b){m.log("Received data channel");var c=b.channel,d=c.label,e=a.labels[d]||{},f=new h(a.peer,c,e);a._attachConnectionListeners(f),a.connections[d]=f,a.emit("connection",f)}},i.prototype._makeOffer=function(){var a=this;this.pc.createOffer(function(b){m.log("Created offer."),a.firefoxSingular=!0,"Webkit"===m.browserisms&&(b.sdp=f.higherBandwidthSDP(b.sdp)),a.pc.setLocalDescription(b,function(){m.log("Set localDescription to offer"),n(a._socket,{type:"OFFER",payload:{sdp:b,config:a._options.config,labels:a.labels},dst:a.peer}),a.labels={}},function(b){a.emit("error",b),m.log("Failed to setLocalDescription, ",b)})})},i.prototype._makeAnswer=function(){var a=this;this.pc.createAnswer(function(b){m.log("Created answer."),"Webkit"===m.browserisms&&(b.sdp=f.higherBandwidthSDP(b.sdp)),a.pc.setLocalDescription(b,function(){m.log("Set localDescription to answer."),n(a._socket,{type:"ANSWER",payload:{sdp:b},dst:a.peer})},function(b){a.emit("error",b),m.log("Failed to setLocalDescription, ",b)})},function(b){a.emit("error",b),m.log("Failed to create answer, ",b)})},i.prototype._cleanup=function(){m.log("Cleanup ConnectionManager for "+this.peer),!this.pc||"closed"===this.pc.readyState&&"closed"===this.pc.signalingState||(this.pc.close(),this.pc=null);var a=this;n(this._socket,{type:"LEAVE",dst:a.peer}),this.open=!1,this.emit("close")},i.prototype._attachConnectionListeners=function(a){var b=this;a.on("close",function(){b.connections[a.label]&&delete b.connections[a.label],Object.keys(b.connections).length||b._cleanup()}),a.on("open",function(){b._lock=!1,b._processQueue()})},i.prototype.handleSDP=function(a,b){a=new RTCSessionDescription(a);var c=this;this.pc.setRemoteDescription(a,function(){m.log("Set remoteDescription: "+b),"OFFER"===b&&c._makeAnswer()},function(a){c.emit("error",a),m.log("Failed to setRemoteDescription, ",a)})},i.prototype.handleCandidate=function(a){var b=new RTCIceCandidate(a.candidate);this.pc.addIceCandidate(b),m.log("Added ICE candidate.")},i.prototype.handleLeave=function(){m.log("Peer "+this.peer+" disconnected."),this.close()},i.prototype.close=function(){if(!this.open)return this.emit("error",new Error("Connections to "+this.peer+"are already closed.")),void 0;for(var a=Object.keys(this.connections),b=0,c=a.length;c>b;b+=1){var d=a[b],e=this.connections[d];e.close()}this.connections=null,this._cleanup()},i.prototype.connect=function(a){if(this.open){for(a=m.extend({label:"peerjs",reliable:"Firefox"===m.browserisms},a);this.connections[a.label];)a.label="peerjs"+this._default,this._default+=1;this.labels[a.label]=a;var b;if(this.pc&&!this._lock){var c="Firefox"===m.browserisms?a.reliable:!1;b=this.pc.createDataChannel(a.label,{reliable:c}),"Firefox"===m.browserisms&&this._makeOffer()}var d=new h(this.peer,b,a);return this._attachConnectionListeners(d),this.connections[a.label]=d,(!this.pc||this._lock)&&this._queued.push(d),this._lock=!0,d}},i.prototype.update=function(a){for(var b=Object.keys(a),c=0,d=b.length;d>c;c+=1){var e=b[c];this.labels[e]=a[e]}},m.inherits(j,e),j.prototype.start=function(){this._startXhrStream(),this._startWebSocket()},j.prototype._startWebSocket=function(){var a=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(b){var c;try{c=JSON.parse(b.data)}catch(d){return m.log("Invalid server message",b.data),void 0}a.emit("message",c)},this._socket.onopen=function(){a._timeout&&(clearTimeout(a._timeout),setTimeout(function(){a._http.abort(),a._http=null},5e3)),m.log("Socket open")})},j.prototype._startXhrStream=function(a){try{var b=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=a||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onreadystatechange=function(){2==this.readyState&&this.old&&(this.old.abort(),delete this.old),this.readyState>2&&200==this.status&&this.responseText&&b._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(c){m.log("XMLHttpRequest not available; defaulting to WebSockets")}},j.prototype._handleStream=function(a){var b=a.responseText.split("\n");if(a._buffer)for(;a._buffer.length>0;){var c=a._buffer.shift(),d=b[c];try{d=JSON.parse(d)}catch(e){a._buffer.shift(c);break}this.emit("message",d)}var f=b[a._index];if(f)if(a._index+=1,a._index===b.length)a._buffer||(a._buffer=[]),a._buffer.push(a._index-1);else{try{f=JSON.parse(f)}catch(e){return m.log("Invalid server message",f),void 0}this.emit("message",f)}},j.prototype._setHTTPTimeout=function(){var a=this;this._timeout=setTimeout(function(){var b=a._http;a._wsOpen()?b.abort():(a._startXhrStream(b._streamIndex+1),a._http.old=b)},25e3)},j.prototype._wsOpen=function(){return!!this._socket&&1==this._socket.readyState},j.prototype.send=function(a){if(!this.disconnected){if(!a.type)return this.emit("error","Invalid message"),void 0;var b=JSON.stringify(a);if(this._wsOpen())this._socket.send(b);else{var c=new XMLHttpRequest,d=this._httpUrl+"/"+a.type.toLowerCase();c.open("post",d,!0),c.setRequestHeader("Content-Type","application/json"),c.send(b)}}},j.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)}}(this),function(a){var b=a.Worker,c=function(a){this.eventQueue={},this.eventBuckets=0,this.worker=new b(a);var c=this;this.worker.addEventListener("message",function(a){var b=a.data;console.log("Message to main!"),console.log(a),c.checkEvents(b)})};a.Worker=c,c.prototype.addEventListener=function(){this.worker.addEventListener.apply(this.worker,arguments)},c.prototype.postMessage=function(){this.worker.postMessage.apply(this.worker,arguments)},c.prototype.terminate=function(){this.worker.terminate()},c.prototype.addMessageEvent=function(a,b){var c=this.eventQueue;a&&"undefined"==typeof c[a]&&(c[a]=[]),"function"==typeof b&&c[a].push(b)},c.prototype.checkEvents=function(a){if(console.log("checkEvents called"),a.request){var b=this.eventQueue[a.request];if(b){for(var c=0;c<b.length;c++)b[c](a.data);delete this.eventQueue[a.request]}}},c.prototype.postMessageWithCallback=function(a,b){var c=a;"string"!=typeof a&&(c=JSON.stringify(a)),this.addMessageEvent(c,b),this.worker.postMessage(a)}}(this),window.nodetron=function(a){var b={uuid:a.uuid};
return a.uuid=null,b}(this),function(a){var b={get:[],post:[],put:[],"delete":[]},c={},d=function(a,b){if(e(a),!b){var c=a.metadata;c&&f(c,a)}},e=function(b){b.on("open",function(){console.log("Connection Opened")}),b.on("data",function(d){a.debug&&console.log("Got DataChannel data:",d);var e=d.id;c[e]?(c[e](d),c[e]=null):f(d,b)}),b.on("error",function(b){a.debug&&console.log("Got DataChannel data:",b)})},f=function(a,c){console.log(a);var d=b[a.method];if(d)for(var e=new g(a,c),f=0;f<d.length&&!d[f](a,e);f++);};a.startPeerConnection=function(b,c){var e=a.self.connect(b,{metadata:c});return d(e,!0),e},a.requestPeerResource=function(b,d,e){if("undefined"==typeof d.resource&&"undefined"==typeof d.id)throw new Error("No resource requested");d.method=d.method||"get";var f=d.id||a.uuid.v4(),g={method:d.method,resource:d.resource,data:d.data,identity:d.identity,id:f};return"object"==typeof b?b=a.startPeerConnection(b.clientId,g):"string"==typeof b?b=a.startPeerConnection(b,g):b.send(g),"function"==typeof e&&(c[f]=e),{connection:b,requestId:f}};var g=function(a,b){this.connection=b,this._id=a.id};g.prototype.send=function(a,b){var c={id:this._id,msg:a,data:b};this.connection.send(c)},g.prototype.accept=function(a){this.send("accept",a)},g.prototype.deny=function(a){this.send("deny",a)};var h=!1;a.registerForPeerRequests=function(c,e){if("undefined"==typeof a.self)throw new Error("Cannot listen for requests. Peer has not been initialized.");h||(a.self.on("connection",d),h=!0);var f=b[c];if(!f)throw new Error("No such request method.");b[c].push(e)};var i=!1;a.registerWithServer=function(b){if("undefined"==typeof b||"undefined"==typeof b.host)throw new Error("Host not specified!");if("localhost"===b.host)throw new Error("Localhost is not a valid option; use 127.0.0.1");if(i)return console.error("Already registered with server!"),void 0;a.id=localStorage.getItem("_nodetron_uuid"),"null"===a.id&&(a.id=null);var c=b.host,d=b.port||80,e=b.config||{iceServers:[{url:"stun:stun.l.google.com:19302"}]},f=b.debug||!1;a.debug=f;var g=io.connect(c+":"+d);a.socket=g,a._options={port:d,config:e,host:c,debug:f},g.on("users",function(a){b.debug&&console.log(a),g.emit("acknowledge",{received:!0})}),b.debug&&g.on("message",function(a){console.log("Nodetron: ",a)}),i=!0};var j=null;a.login=function(b){var c=b.id||a.id;(b.newId||!c)&&(c=a.uuid.v4(),j=a.uuid.v4()),a.id=c,localStorage.setItem("_nodetron_uuid",c);var d=b.key||"default",e=b.userData;j=j||a.uuid.v4(),a.socket.emit("login",{key:d,id:c,token:j,metadata:e}),a._options.key=b.key;var f=a.self=new Peer(c,a._options,a.socket);f.on("error",function(a){b.debug&&console.log("Got an error:",a)}),f.on("close",function(a){b.debug&&console.log("Connection closed",a)}),f.on("open",function(a){b.debug&&console.log("Connection Opened, User ID is",a)})},a.findPeer=function(b,c){var d=a.uuid.v4();a.activeQueries=a.activeQueries||{},a.activeQueries[d]=c,a.socket.emit("query_for_user",{queryId:d,queryParam:b});var e=function(b){if(console.log("Received queryResponse from Server"),!a.activeQueries[b.queryId])throw new Error("Bad query response from server",b);a.activeQueries[b.queryId](b.users),delete a.activeQueries[d]};a.socket.on("query_response",e)},Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError("Object.keys called on non-object");var f=[];for(var g in e)a.call(e,g)&&f.push(g);if(b)for(var h=0;d>h;h++)a.call(e,c[h])&&f.push(c[h]);return f}}()),Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),a.worker=new Worker("scripts/nodetron/background/workerInternal.js"),a.init=function(b){var c={init:!0,uuid:uuid,registered:i,dbTitle:b.dbTitle,dbVersion:b.dbVersion,serverUrl:b.serverUrl};a.worker.postMessage(c),a.worker.addEventListener("message",function(a){console.log("Message to main!"),console.log(a)})}}(this.nodetron||(this.nodetron={}));